<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:cxf="http://www.mulesoft.org/schema/mule/cxf" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/cxf http://www.mulesoft.org/schema/mule/cxf/current/mule-cxf.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
    <http:listener-config name="HTTP_Listener_Configuration" host="0.0.0.0" port="8081" doc:name="HTTP Listener Configuration"/>
    <cxf:configuration name="CXF_Configuration" enableMuleSoapHeaders="true" initializeStaticBusInstance="true" doc:name="CXF Configuration"/>
    <db:generic-config name="Postrgres_Configuration_A3" url="jdbc:postgresql://localhost:5433/is_assignment3?password=postgres&amp;user=postgres" driverClassName="org.postgresql.Driver" doc:name="Generic Database Configuration"/>
    <flow name="is_assignment3Flow">
        <http:listener config-ref="HTTP_Listener_Configuration" path="/management" doc:name="HTTP Index"/>
        <cxf:jaxws-service configuration-ref="CXF_Configuration" serviceClass="is_assignment3.Management_Web" doc:name="CXF"/>
        <choice doc:name="Choice">
            <when expression="method.name.equals(&quot;addFollower&quot;)">
                <logger message="#[server.dateTime.format(&quot;dd-MMM-yy hh:mm:ss&quot;).toUpperCase()] #[&quot;AddFollower called&quot;]" level="DEBUG" doc:name="Logger"/>
                <set-variable variableName="email" value="#[payload[0]]" doc:name="Variable_email"/>
                <set-variable variableName="brand" value="#[payload[1]]" doc:name="Variable_brand"/>
                <set-variable variableName="priceMin" value="#[payload[2]]" doc:name="Variable_priceMin"/>
                <set-variable variableName="priceMax" value="#[payload[3]]" doc:name="Variable_priceMax"/>
                <db:select config-ref="Postrgres_Configuration_A3" doc:name="Database">
                    <db:parameterized-query><![CDATA[SELECT * from followers WHERE (email=#[flowVars.email] and brand=#[flowVars.brand]);]]></db:parameterized-query>
                </db:select>
                <choice doc:name="Choice">
                    <when expression="#[payload.size() != 0]">
                        <set-payload value="#[&quot;Already following&quot;]" doc:name="Set Payload"/>
                    </when>
                    <otherwise>
                        <logger message="#[&quot;Not present in DB&quot;]" level="DEBUG" doc:name="Logger"/>
                        <db:insert config-ref="Postrgres_Configuration_A3" doc:name="Database">
                            <db:parameterized-query><![CDATA[INSERT INTO followers (email, brand, price_min, price_max) values (#[flowVars.email], #[flowVars.brand], #[flowVars.priceMin], #[flowVars.priceMax]);]]></db:parameterized-query>
                        </db:insert>
                        <set-payload value="#[payload.toString()]" doc:name="Set Payload"/>
                    </otherwise>
                </choice>
            </when>
            <when expression="method.name.equals(&quot;listFollowers&quot;)">
                <logger message="#[server.dateTime.format(&quot;dd-MMM-yy hh:mm:ss&quot;).toUpperCase()] #[&quot;ListFollowers called&quot;]" level="DEBUG" doc:name="Logger"/>
                <db:select config-ref="Postrgres_Configuration_A3" doc:name="Database">
                    <db:parameterized-query><![CDATA[SELECT * FROM followers;]]></db:parameterized-query>
                </db:select>
            </when>
            <when expression="method.name.equals(&quot;removeFollower&quot;)">
                <logger message="#[server.dateTime.format(&quot;dd-MMM-yy hh:mm:ss&quot;).toUpperCase()] #[&quot;RemoveFollower called&quot;]" level="DEBUG" doc:name="Logger"/>
                <set-variable variableName="email" value="#[payload[0]]" doc:name="Variable_email"/>
                <db:select config-ref="Postrgres_Configuration_A3" doc:name="Database">
                    <db:parameterized-query><![CDATA[SELECT * FROM followers WHERE email = #[flowVars.email]]]></db:parameterized-query>
                </db:select>
                <choice doc:name="Choice">
                    <when expression="#[payload.size() != 0]">
                        <db:delete config-ref="Postrgres_Configuration_A3" doc:name="Database">
                            <db:parameterized-query><![CDATA[DELETE FROM followers WHERE email=#[flowVars.email];]]></db:parameterized-query>
                        </db:delete>
                        <logger message="#[server.dateTime.format(&quot;dd-MMM-yy hh:mm:ss&quot;).toUpperCase()] #[&quot;Removed follower&quot;]" level="INFO" doc:name="Logger"/>
                        <set-payload value="#[&quot;Removed follower&quot; + #[flowVars.email]]" doc:name="Set Payload"/>
                    </when>
                    <otherwise>
                        <logger message="#[server.dateTime.format(&quot;dd-MMM-yy hh:mm:ss&quot;).toUpperCase()] #[&quot;No follower found with this emai. Payload: &quot; + #[payload.toString()]]" level="INFO" doc:name="Logger"/>
                        <set-payload value="#[&quot;No follower was found with this email&quot;]" doc:name="Set Payload"/>
                    </otherwise>
                </choice>
            </when>
            <otherwise>
                <logger message="#[server.dateTime.format(&quot;dd-MMM-yy hh:mm:ss&quot;).toUpperCase()] #[&quot;Not a valid function&quot;]#[exception] #[payload[0]]" level="ERROR" doc:name="Logger"/>
                <set-payload value="#[&quot;Wrong option&quot;]" doc:name="Set Payload"/>
            </otherwise>
        </choice>
    </flow>
</mule>
